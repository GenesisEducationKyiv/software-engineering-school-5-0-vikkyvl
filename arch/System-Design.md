# System Design: Weather API Application

## 1. Вимоги системи
## Функціональні вимоги

- Користувач може підписуватися через вебсайт на отримання оновлень(погодинно/щодня) погоди для вибраного міста на електронну пошту.
- Система надсилає користувачу лист із підтвердженням підписки.
- Після підтвердження підписки, система надсилає користувачу регулярні оновлення погоди для вибраного міста. 
- Користувач може скасувати підписку на отримання оновлень погоди за посиланням, що міститься в електронному листі.

## Нефункціональні вимоги

- **Доступність**: Система повинна бути доступною 99.9% uptime.
- **Масштабованість**: Система має адаптуватись до різної кількості користувачів з очікуваною підтримкою до 10 000 користувачів та обробкою понад 50 000 повідомлень на добу, включаючи надсилання електронних листів із погодою та запити до зовнішнього Weather API.
- **Затримка**: При взаємодії між сервісами не повинна перевищувати 200 мілісекунд, тоді як загальний час обробки операція, як звернення до зовнішнього Weather API та надсилання листа з підтвердження підписки - < 2 секунд.
- **Надійність**: Повідомлення між сервісами мають доставлятись гарантовано, а також забезпечення безперебійної роботи при всіх навантаженнях.
- **Сумісність**: Коректна робота в сучасних браузерах, зокрема на основі рушіїв Chromium(Google Chrome, Microsoft Edge), Gecko(Mozilla Firefox) та WebKit(Safari).
- **Безпека**: Дотримання принципи OWASP Top Ten, зокрема: уникнення SQL-ін'єкцій, валідація вхідних даних та регулярне проведення аудитів безпеки.

## Обмеження
- Budget: Мінімальні витрати на інфраструктуру.
- External API rare limits: Безкоштовний план Weather API має обмеження на кількість запитів на місяць(1 000 000 запитів).
- Email delivery limits: Оскільки безкоштовні поштові сервіси зазвичай дозволяють надсилати обмежену кількість листів(наприклад, до 100 листів на годину з одного домену), використовується недорога підписка, щоб забезпечити надсилання щонайменше 24 000 листів на добу. 
- Compliance: Дотримання GDPR для обробки персональних даних користувачів, зокрема, надання можливості користувачам видаляти свої дані та скасовувати підписку.

## 2. Оцінка навантаження

### Користувачі та трафік
- Максимальна кількість зареєстрованих користувачів: до 10 000.
- Активних підписок на день: до 5 000.
- Розсилка за підпискою: для користувачів із щоденною частотою - приблизно 3 500 - 4 000 листів/день, а для щогодинних підписок - решта(~ 1 000 - 1 500 листів/день).
- API-запити від клієнтів: до 100 RPS у пікові години.

### Дані
- Користувацькі записи(email, місто, частота оновлення(щоденно/щогодини), токен підтвердження, статус, дати створення та оновлення): ~ 200 байт.
- Погода(зберігається температура, вологість, опис погоди та дата створення): ~ 100 - 200 байт.
- Загальний обсяг: разом дані користувача(Кількість записів 15 000 підписок - ~ 3-4 MB) і погоди(Збереження по 100 міст щогодини(24/день) - ~ 2.5 MB/день) - ~ 120 - 160 MB/рік.

### Bandwidth
- Incoming: ~ 1 Mbps(Клієнт надсилає HTTP-запит до API Gateway).
- Outgoing: ~ 5 Mbps(HTTP-відповіді та email-розсилка користувачам).
- SMTP: ~ 15KB/лист * 15 000 листів/день = ~ 225 MB/день -> ≈ 0.026 MB/S ≈ 0.2 Mbps.
- Weather API: ~ 1.5KB/лист * 10 000 листів/день = ~ 15 MB/день -> ≈ 0.00017 MB/S ≈ 0.0013 Mbps.

## 3. High-Level архітектура
![Image](https://github.com/user-attachments/assets/63e79339-3d0a-4bdb-9cba-4713b03c835c)

## 4. Детальний дизайн компонентів

### API Gateway(Node.js/NestJS)
### Відповідальність
- Прийом HTTP-запитів від клієнтів(веб або мобільний інтерфейс).
- Маршрутизація запитів через RabbitMQ до відповідних мікросервісів.
- Обробка помилок.
- Формування HTTP-відповідей для клієнтів.

### Weather Service(Node.js/NestJS)
### Відповідальність
- Виконання запитів до зовнішнього Weather API для отримання поточної погоди.
- Зберігання отриманих даних про погоду в PostgreSQL.

### Endpoints
<code>GET /api/weather?city={city}</code>  - Отримати поточну погоду для вказаного міста, включаючи темпретару, вогологість і опис погодніх умов.

### Subscription Service(Node.js/NestJS)
### Відповідальність
- Обробка підписок користувачів.
- Зберігає дані в PostgreSQL.
- Надсилання листів з підтвердженням підписки.
- Обробка підтверджень підписок та їх скасувань.

### Endpoints
<code>POST /api/subscribe</code> - Підписка користувача за вказаним email з вибраним містом та частотою оновлень(щодня/щогодини).

<code>GET /api/confirm/{token}</code> - Підтвердження підписки за токеном, який надіслано на email користувача.

<code>GET /api/unsubscribe/{token}</code> - Скасування підписки за токеном, який надіслано на email користувача.

### 5. База даних
### PostgreSQL
Для зберігання даних користувачів та погоди використовується реляційна база даних PostgreSQL, оскільки вона забезпечує надійність, масштабованість та підтримку складних запитів.

#### Weather
| Поле          | Тип         | Ключ | Опис                           |
|---------------|-------------|------|--------------------------------|
| `id`          | `SERIAL`    | PK   | Числовий ідентифікатор запису  |
| `city`        | `VARCHAR`   |      | Назва міста                    |
| `temperature` | `DOUBLE`    |      | Температура в градусах Цельсія |
| `humidity`    | `DOUBLE`    |      | Відносна вологість у відсотках |
| `description` | `VARCHAR`   |      | Опис погодних умов             |
| `created_at`  | `TIMESTAMP` |      | Дата та час створення запису   |


#### Subscription
| Поле         | Тип                       | Ключ | Опис                                              |
|--------------|---------------------------|------|---------------------------------------------------|
| `id`         | `UUID`                    | PK   | Унікальний ідентифікатор підписки                 |
| `email`      | `VARCHAR`                 |      | Email користувача                                 |
| `city`       | `VARCHAR`                 |      | Назва міста для підписки                          |
| `frequency`  | `ENUM`(`daily`, `hourly`) |      | Частота оновлень(щодня / щогодини)                |
| `confirmed`  | `BOOLEAN`                 |      | Чи підтверджено підписку                          |
| `token`      | `VARCHAR`                 |      | Токен підтвердження підписки/ скакування підписки |
| `created_at` | `TIMESTAMP`               |      | Дата та час створення запису                      |
| `updated_at` | `TIMESTAMP`               |      | Дата останнього оновлення                         |


### 6. Message Broker

### RabbitMQ
- Використовується як посередник для асинхронної комунікації між API Gateway і мікросервісами(Weather Service та Subscription Service).
- Мікросервіси слухають конкретні черги RabbitMQ, обробляють запит від API Gateway та надсилають відповіді назад через цей Message Broker.
- Ізоляція мікросервісів, що дозволяє їм працювати незалежно один від одного.
- Гарантує надійну доставку повідомлень.